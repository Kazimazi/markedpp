/**
 * Markdown Preprocessor
 *
 * @copyright 2014 commenthol
 * @licence MIT
 * 
 * @note Code inspired by `marked` project
 * @credits Christopher Jeffrey <https://github.com/chjj/marked>
 */
(function(ctx){"use strict";var defaults={gfm:true,breaks:true,tags:true,level:3,minlevel:1};function isNodeJs(){return typeof process!=="undefined"&&typeof module!=="undefined"&&module.exports}function replace(regex,opt){regex=regex.source;opt=opt||"";return function self(name,val){if(!name)return new RegExp(regex,opt);val=val.source||val;val=val.replace(/(^|[^\[])\^/g,"$1");regex=regex.replace(name,val);return self}}function noop(){}noop.exec=noop;function merge(obj){var i=1,target,key;for(;i<arguments.length;i++){target=arguments[i];for(key in target){if(Object.prototype.hasOwnProperty.call(target,key)){obj[key]=target[key]}}}return obj}var path={normalizeArray:function(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==="."){parts.splice(i,1)}else if(last===".."){parts.splice(i,1);up++}else if(up){parts.splice(i,1);up--}}if(allowAboveRoot){for(;up--;up){parts.unshift("..")}}return parts},resolve:function(){var resolvedPath="",resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:"/";if(!path){continue}resolvedPath=path+"/"+resolvedPath;resolvedAbsolute=path.charAt(0)==="/"}resolvedPath=this.normalizeArray(resolvedPath.split("/").filter(function(p){return!!p}),!resolvedAbsolute).join("/");return(resolvedAbsolute?"/":"")+resolvedPath||"."},splitPathRe:/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,splitPath:function(filename){return this.splitPathRe.exec(filename).slice(1)},dirname:function(path){var result=this.splitPath(path),root=result[0],dir=result[1];if(!root&&!dir){return"."}if(dir){dir=dir.substr(0,dir.length-1)}return root+dir},join:function(){return Array.prototype.slice.call(arguments).join("/")}};var async={_eachLimit:function(limit){return function(arr,iterator,callback){callback=callback||function(){};if(!arr.length||limit<=0){return callback()}var completed=0;var started=0;var running=0;(function replenish(){if(completed>=arr.length){return callback()}while(running<limit&&started<arr.length){started+=1;running+=1;iterator(arr[started-1],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;running-=1;if(completed>=arr.length){callback()}else{replenish()}}})}})()}},eachLimit:function(arr,limit,iterator,callback){var fn=this._eachLimit(limit);fn.apply(null,[arr,iterator,callback])}};function xhr(url,options,callback){if(typeof options==="function"){callback=options;options=null}var o=options?options:{};var self=this,req=new XMLHttpRequest,method=o.method||"get",async=typeof o.async!=="undefined"?o.async:true,params=o.data||null,key;req.queryString=params;req.open(method,url,async);req.setRequestHeader("X-Requested-With","XMLHttpRequest");if(method.toLowerCase()=="post"){req.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}for(key in o.headers){if(o.headers.hasOwnProperty(key)){req.setRequestHeader(key,o.headers[key])}}function stateChange(){if(req.readyState===4){if(/^[20]/.test(req.status)){callback(null,req.responseText)}else if(/^[45]/.test(req.status)){callback(new Error(req.status))}}}if(async){req.onreadystatechange=stateChange}req.send(params);if(!async)stateChange()}var ppInclude;if(isNodeJs()){ppInclude=require("./ppinclude")(Lexer,merge)}else{ppInclude=function(tokens,options,callback){var dirname=options.dirname||"/",lexed={},_options=merge({},options);if(!_options.ppInclude){_options.ppInclude={}}async.eachLimit(tokens,5,function(token,done){if(token.type==="ppinclude"&&typeof token.text==="string"&&!_options.ppInclude[token.text]){var path_=path.resolve(path.join(path.dirname(location.pathname),dirname,token.text));var url=location.origin+path_;xhr(url,function(err,src){_options.ppInclude[token.text]=1;_options.dirname=path.dirname(path_);if(err){console.error("Error: "+err.message);return done()}var lexer=new Lexer(_options);ppInclude(lexer.lex(src),_options,function(err,ntokens){lexed[token.text]=ntokens;done()})})}else{done()}},function(err){var _tokens=[];tokens.forEach(function(token,idx){if(token.type==="ppinclude"&&typeof token.text==="string"&&lexed[token.text]!==undefined){_tokens.push({type:"ppinclude.start",text:token.text,indent:token.indent,lang:token.lang});lexed[token.text].forEach(function(token){_tokens.push(merge({},token))});_tokens.push({type:"ppinclude.end",lang:token.lang})}else{_tokens.push(token)}});callback(null,_tokens)})}}var rules={heading:/^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)/,lheading:/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/,fences:noop,_ppopts_:/ ?(?:\(([^\)]+)\))?/,ppinclude:/^( *)(?:\!(?:INCLUDE|include)_ppopts_|_ppinclude_|_ppincludeCompat_) *(?:\n|$)/,_ppinclude_:/<!-- *include_ppopts_ *-->(?:(?!<!-- *\/include * -->)[^])*<!-- *\/include * -->/,_ppincludeCompat_:/\!INCLUDE "([^"]+)"/,ppnumberedheadings:/^ *(?:\!(?:NUMBEREDHEADINGS|numberedheadings)_ppopts_|_ppnumberedheadings_) *(?:\n+|$)/,_ppnumberedheadings_:/<!-- \!*numberedheadings_ppopts_ *-->/,pptoc:/^(?:\!(?:TOC|toc)_ppopts_|_pptoc_|_pptocCompat1_|_pptocCompat2_) *(?:\n+|$)/,_pptoc_:/<!-- *\!toc_ppopts_ *-->(?:(?!<!-- *toc\! * -->)[^])*<!-- *toc\! * -->/,_pptocCompat1_:/<!-- *toc *-->(?:(?!<!-- *\/toc * -->)[^])*<!-- *\/toc * -->/,_pptocCompat2_:/<!-- *toc *-->/,ppref:/^(?:\!(?:REF|ref)|_ppref_|_pprefCompat_) *(?:\n|$)/,_ppref_:/<!-- *\!ref *-->(?:(?!<!-- *ref\! * -->)[^])*<!-- *ref\! * -->/,_pprefCompat_:/<!-- *ref *-->(?:(?!<!-- *\/ref * -->)[^])*<!-- \/ref * -->/,def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +["(]([^\n]+)[")])? *(?:\n|$)/,text:/^[^\n]*\n/};rules.gfm={fences:/^ *(`{3,}|~{3,}) *(\S+)? *\n([\s\S]+?)\s*\1 *(?:\n|$)/};rules.ppinclude=replace(rules.ppinclude)("_ppinclude_",rules._ppinclude_)("_ppincludeCompat_",rules._ppincludeCompat_)("_ppopts_",rules._ppopts_)("_ppopts_",rules._ppopts_)();rules.ppnumberedheadings=replace(rules.ppnumberedheadings)("_ppnumberedheadings_",rules._ppnumberedheadings_)("_ppopts_",rules._ppopts_)("_ppopts_",rules._ppopts_)();rules.pptoc=replace(rules.pptoc)("_pptoc_",rules._pptoc_)("_ppopts_",rules._ppopts_)("_ppopts_",rules._ppopts_)("_pptocCompat1_",rules._pptocCompat1_)("_pptocCompat2_",rules._pptocCompat2_)();rules.ppref=replace(rules.ppref)("_ppref_",rules._ppref_)("_pprefCompat_",rules._pprefCompat_)();function Lexer(options){this.tokens=[];this.options=options||defaults;this.rules=rules;if(this.options.gfm){this.rules.fences=rules.gfm.fences}}Lexer.prototype.lex=function(src){src=src.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n");return this.token(src,true)};Lexer.prototype.token=function(src){var cap,tmp,opts,self=this;src=src.replace(/^ +$/gm,"");while(src){if(cap=this.rules.heading.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"heading",depth:cap[1].length,text:cap[2],raw:cap[2]});continue}if(cap=this.rules.lheading.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"heading",depth:cap[2]==="="?1:2,text:cap[1],raw:cap[1]});continue}if(cap=this.rules.fences.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"code",lang:cap[2],text:cap[3]});continue}if(cap=this.rules.ppnumberedheadings.exec(src)){src=src.substring(cap[0].length);opts=Lexer.splitOpts(cap[1]||cap[2]);this.tokens.push({type:"ppnumberedheadings",level:Lexer.range(opts.level,1,6,3),minlevel:Lexer.range(opts.minlevel,1,6)});continue}if(cap=this.rules.pptoc.exec(src)){src=src.substring(cap[0].length);opts=Lexer.splitOpts(cap[1]||cap[2]);if(typeof opts.omit==="string"){opts.omit=[opts.omit]}this.tokens.push({type:"pptoc",level:Lexer.range(opts.level,1,6,3),minlevel:Lexer.range(opts.minlevel,1,6),numbered:opts.numbered,omit:opts.omit});continue}if(cap=this.rules.ppinclude.exec(src)){src=src.substring(cap[0].length);tmp=cap[2]||cap[3]||cap[4];opts=Lexer.splitOpts(tmp);tmp=tmp.replace(/ *(?:[a-z]+=[a-z0-9\-]+)/,"").replace(/\\ /g," ");this.tokens.push({type:"ppinclude",text:tmp,indent:cap[1],lang:opts.lang});continue}if(cap=this.rules.ppref.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"ppref"});continue}if(cap=this.rules.def.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"def",ref:cap[1],href:cap[2],title:cap[3]});continue}if(cap=this.rules.text.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"text",text:cap[0]});continue}if(src){throw new Error("Infinite loop on byte: "+src.charCodeAt(0))}}return this.tokens};Lexer.rules=rules;Lexer.lex=function(src,options,callback){var lexer=new Lexer(options);var tokens=lexer.lex(src);ppInclude(tokens,options,function(err,tokens){callback(err,tokens)})};Lexer.splitOpts=function(str){var opts={},sep,tmp="",KEY=/^(.+)$/,KEYVALUE=/^([a-z0-9]+)=(.*)$/,KEYVALUES=/^([a-z0-9]+)=(["'])(.*?)\2$/;(str||"").split(" ").forEach(function(s){if(/\\$|^["'].*[^"']$/.test(s)||sep&&!sep.test(s)){tmp+=s+" ";return}if(/\=(["']).*[^"']$/.test(s)){sep=s.replace(/^.*\=(["']).*[^"']$/,"$1");sep=new RegExp(sep+"$");tmp+=s+" ";return}if(tmp){s=tmp+s;tmp="";sep=undefined}if(KEYVALUES.test(s)){s.replace(KEYVALUES,function(m,key,x,value){opts[key]=value.split(";");opts[key]=opts[key].map(function(value){var tmp=parseInt(value,10);if(!isNaN(tmp)){value=tmp}return value});if(opts[key].length===1){opts[key]=opts[key][0]}})}else if(KEYVALUE.test(s)){s.replace(KEYVALUE,function(m,key,value){var tmp=parseInt(value,10);if(!isNaN(tmp)){value=tmp}opts[key]=value})}else if(KEY.test(s)){s=s.replace(/\\ /g," ").replace(/^(["'])([^\1]+)\1$/,"$2");if(/^\!(.*)$/.test(s)){s=s.replace(/^\!(.*)$/,"$1");opts[s]=false}else{opts[s]=true}}});return opts};Lexer.range=function(val,min,max,def){if(val<min){return min}else if(val>max){return max}else{if(def&&val===def){return undefined}return val}};function Numbering(){this._=[0,0,0,0,0,0,0];this.last=1}Numbering.prototype.reset=function(level){for(var i=level+1;i<this._.length;i++){this._[i]=0}};Numbering.prototype.val=function(level){var i,out=this._[1];for(i=2;i<=level;i++){out+="."+this._[i]}return out+"\\."};Numbering.prototype.count=function(level){if(level<=6){if(this.last>level){this.reset(level)}this._[level]+=1;this.last=level;return this.val(level)}return};function Renderer(options){this.options=options||{};this._indent=""}Renderer.prototype.heading=function(text,level,raw,number){var atx="########".substring(0,level);return this._indent+atx+" "+text+"\n\n"};Renderer.prototype.paragraph=function(text){return this._indent+text};Renderer.prototype.code=function(code,lang){return this.fences(lang)+code+"\n"+this.fences()};Renderer.prototype.reference=function(ref,href,title){return this._indent+"["+ref+"]: "+href+(title?' "'+title+'"':"")+"\n"};Renderer.prototype.include=function(text,indent,lang){return this._indent+indent+"!include ("+text+(lang?" lang="+lang:"")+")\n"};Renderer.prototype.fences=function(lang){return this._indent+"```"+(lang?lang:"")+"\n"};Renderer.prototype.indent=function(indent){this._indent=indent};Renderer.sortByTitle=function(a,b){var _a=a.title.toLowerCase(),_b=b.title.toLowerCase();if(_a>_b){return 1}else if(_a<_b){return-1}else{return 0}};Renderer.prototype.referenceId=function(raw){return raw.toLowerCase().replace(/[^\w]+/g,"-")};Renderer.prototype.references=function(refs){var out=[];refs.map(function(ref){if(!ref.title){ref.title=ref.ref}return ref}).sort(Renderer.sortByTitle).forEach(function(ref){out.push("* ["+ref.title+"]["+ref.ref+"]")});if(this.options.tags){return"<!-- !ref -->\n\n"+out.join("\n")+"\n\n<!-- ref! -->\n"}else{return out.join("\n")+"\n"}};Renderer.prototype.tableOfContents=function(toc,options){var self=this,i,omitlevel,out=[],opts=this.composeOpts({level:options.level,minlevel:options.minlevel,numbered:options.numbered,omit:options.omit}),numbering=new Numbering,br=this.options.breaks?" <br>":"",level=options.level||defaults.level,minlevel=options.minlevel||defaults.minlevel;out=toc.filter(function(t){if(t.depth<=level&&t.depth>=minlevel){return true}return false}).map(function(t){if(!t.number&&options.numbered){t.number=numbering.count(t.depth-minlevel+1)}return t}).filter(function(t){if(options.omit){if(omitlevel){if(t.depth>omitlevel){return false}else{omitlevel=undefined}}return!options.omit.some(function(tt){if(tt===t.raw){omitlevel=t.depth;return true}return false})}return true}).map(function(t){if(options.numbered){if(self.options.numberedHeadings){return t.number+" ["+self.removeLinkFromHeadings(t.raw)+"](#"+self.referenceId(t.text)+")"+br}else{return t.number+" ["+self.removeLinkFromHeadings(t.text)+"](#"+self.referenceId(t.text)+")"+br}}else{var space="";for(var i=1;i<(t.depth-minlevel+1||1);i++){space+="  "}return space+"* ["+self.removeLinkFromHeadings(t.text)+"](#"+self.referenceId(t.text)+")"}});if(this.options.tags){return"<!-- !toc "+opts+"-->\n\n"+out.join("\n")+"\n\n<!-- toc! -->\n\n"}else{return out.join("\n")+"\n\n"}};Renderer.prototype.numberedHeadings=function(maxLevel,minLevel){var opts=this.composeOpts({level:maxLevel,minlevel:minLevel});if(this.options.tags){return"<!-- !numberedheadings "+opts+"-->\n\n"}return""};Renderer.prototype.composeOpts=function(obj){var key,val,tmp=[];for(key in obj){val=obj[key];if(val===true){tmp.push(key)}else if(val!==undefined){if(Array.isArray(val)){val='"'+val.join(";")+'"'}tmp.push(key+"="+val)}}if(tmp.length>0){return"("+tmp.join(" ")+") "}else{return""}};Renderer.prototype.removeLinkFromHeadings=function(heading){return heading.replace(/\[([^\]]*)\]\s*(?:\[[^\]]*\]|\([^\)]*\))/g,"$1")};function Parser(options){this.tokens=[];this.token=null;this.count=-1;this.indent=[];this.options=options||defaults;this.options.renderer=this.options.renderer||new Renderer;this.renderer=this.options.renderer;this.renderer.options=this.options}Parser.prototype.parse=function(tokens){this.tokens=tokens;var out="";while(this.next()){out+=this.tok()}return out};Parser.prototype.next=function(){this.token=this.tokens[this.count+=1];return this.token};Parser.prototype.peek=function(){return this.tokens[this.count+1]||0};Parser.prototype.references=function(){return this.tokens.filter(function(token){if(token.type==="def"&&!/^#/.test(token.href)){return true}return false}).map(function(token){return{ref:token.ref,href:token.href,title:token.title}})};Parser.prototype.tableOfContents=function(){return this.tokens.filter(function(token){if(token.type==="heading"){return true}return false})};Parser.prototype.numberedHeadings=function(maxLevel,minLevel){var REMOVENUMBER=/^([0-9]+\\?\.)+ +/,numbering=new Numbering;maxLevel=maxLevel||defaults.level;minLevel=minLevel||defaults.minlevel;this.tokens=this.tokens.map(function(token){if(token.type==="heading"){token.text=token.text.replace(REMOVENUMBER,"");token.raw=token.raw.replace(REMOVENUMBER,"");if(token.depth<=maxLevel&&token.depth>=minLevel){token.number=numbering.count(token.depth-minLevel+1);token.text=token.number+" "+token.text}}return token})};Parser.prototype.tok=function(){var tmp="";switch(this.token.type){case"heading":{return this.renderer.heading(this.token.text,this.token.depth,this.token.raw,this.token.number)}case"text":{return this.renderer.paragraph(this.token.text)}case"code":{return this.renderer.code(this.token.text,this.token.lang)}case"def":{return this.renderer.reference(this.token.ref,this.token.href,this.token.title)}case"ppnumberedheadings":{this.options.numberedHeadings=true;this.numberedHeadings(this.token.level,this.token.minlevel);return this.renderer.numberedHeadings(this.token.level,this.token.minlevel)}case"ppref":{return this.renderer.references(this.references())}case"ppinclude.start":{this.indent.push(this.token.indent);this.renderer.indent(this.indent.join(""));if(typeof this.token.lang==="string"){tmp=this.renderer.fences(this.token.lang)}return tmp}case"ppinclude.end":{if(typeof this.token.lang==="string"){tmp=this.renderer.fences()}this.indent.pop();this.renderer.indent(this.indent.join(""));return tmp}case"ppinclude":{return this.renderer.include(this.token.text,this.token.indent,this.token.lang)}case"pptoc":{return this.renderer.tableOfContents(this.tableOfContents(),this.token)}default:{return"<!-- "+JSON.stringify(this.token)+" -->\n"}}};Parser.parse=function(tokens,options){var parser=new Parser(options);return parser.parse(tokens)};function markedpp(src,options,callback){if(typeof options==="function"){callback=options;options=null}options=merge({},defaults,options||{});Lexer.lex(src,options,function(err,tokens){var out=Parser.parse(tokens,options);callback(null,out)})}markedpp.defaults=defaults;markedpp.Lexer=Lexer;markedpp.merge=merge;markedpp.setOptions=function(opt){merge(defaults,opt);return markedpp};if(isNodeJs()){module.exports=markedpp}else if(typeof define!=="undefined"&&define.amd){define([],function(){return markedpp})}else if(typeof ctx.Window!=="undefined"&&!ctx[markedpp]){ctx.markedpp=markedpp}})(this);